---
categories: ASP.net
---
# WebApi

没有任何视图,由其他客户端提供.

只接受JSON和只返回JSON,因为不包含视图

主要用于创建Http的RESTful服务

`ControllerBase` 继承于这个基类,与MVC不同.MVC为`Controller`


## ApiController

`[Route("api/[controller]")]` 必须要表明这个


`[ApiController]` ApiController必须标明这个

它的作用:

规范了只接受JSON和只返回JSON

复杂类型从Body中获得

如果没有则是MVC的模型绑定优先从表单中获得

```C#
//这里的id必须和参数的id名称一样.路由参数名称和方法参数名称必须匹配
[HttpPut("{id}")]
//第一个参数由路由得到(因为是简单类型),第二个由请求体得到
//Bind指明只有这两个参数,以外的会被排除.但是有说在Webapi中不起用的,要用DTO
public async Task<IActionResult> PutCity(Guid id, [Bind(nameof(City.CityId),nameof(City.Name))] City city)
{
    //因为两个参数来源不同地方,所以这里还得检查是不是同一个City
    if (id != city.CityId)
    {
        return BadRequest();
    }
    //something
}
```

```C#
//转到GetCity方法给你看刚刚创建的信息.
return CreatedAtAction("GetCity", new { id = city.CityId }, city)
```

## ProblemDetails

和BadRequest不同是,Problem更加统一格式.

```C#
//return NotFound();
return Problem(detail:"Invalid CityID",statusCode:400,title:"City not found")
```

### ValidationProblem
```C#
//其实这个在API项目自动启动,可以不写
if (!ModelState.IsValid)
{
    return ValidationProblem(ModelState);
}
```

## ActionResult<>

用来返回object的,转化为JSON

`Task <ActionResult<City>>` 返回ObjectResult,OK()

## Swagger

`Swashbuckle.AspNetCore` NuGet包

```C#
//让 ASP.NET Core 能“发现”你的 API 端点
builder.Services.AddEndpointsApiExplorer();
//添加swager文档
builder.Services.AddSwaggerGen();

var app = builder.Build();

app.UseSwagger();
app.UseSwaggerUI();
```

### Swagger文档生成

在apicontroller的action上写好注释.

右键解决方案->配置->Debug->XML文档 生成 Path="api.xml"

运行一下 将api.xml生成

```C#
builder.Services.AddSwaggerGen(options =>
{
    //AppContext.BaseDirectory为当前解决方案加项目的根路径
    options.IncludeXmlComments(Path.Combine(AppContext.BaseDirectory,"api.xml"));
});
```
## 内容协商

```C#
builder.Services.AddControllers(options =>
{
    //设置响应类型,如果不设置有默认的3个JSon
    options.Filters.Add(new ProducesAttribute("application/json"));
    //设置请求类型
    options.Filters.Add(new ConsumesAttribute("application/json"));

});
```

方法自定义
```C#
//设置响应类型
[Produces("application/xml")]
public async Task<ActionResult<IEnumerable<City>>> GetCities()
{

}

//Program.cs
builder.Services.AddControllers(options =>
{
    options.Filters.Add(new ProducesAttribute("application/json"));
    options.Filters.Add(new ConsumesAttribute("application/json"));
})
//开启xml序列化,默认没有xml序列化,性能消耗大
.AddXmlSerializerFormatters();
```

POST一定要是"application/json".

## API版本

可以用不同版本对应不同控制器

`Asp.Versioning.Mvc`

`Asp.Versioning.Mvc.ApiExplorer`

```C#
builder.Services.AddApiVersioning(config =>
    {
        //从Url中查找
        //api-version
        config.ApiVersionReader = new UrlSegmentApiVersionReader();
        
        //从请求头中
        //config.ApiVersionReader = new HeaderApiVersionReader();
        
        //从查询语句
        //config.ApiVersionReader = new QueryStringApiVersionReader();
        
        //config.ApiVersionReader = new MediaTypeApiVersionReader();

        //设置默认版本
        config.DefaultApiVersion = new ApiVersion(1.0);
        //如果没指定则为默认版本
        config.AssumeDefaultVersionWhenUnspecified = true;

    });
    //可以不需要,在AddController中添加了轻量级的,除非有视图再用这个
    //.AddMvc()

    //查找端点
    .AddApiExplorer(option =>
    {
        option.GroupNameFormat = "'v'VVV";
        option.SubstituteApiVersionInUrl = true;
    });

    //这个也不需要,有AddApiExplorer就可以
    //让 ASP.NET Core 能“发现”你的 API 端点
    //builder.Services.AddEndpointsApiExplorer();

```

```C#
//也可以为控制器方法注释
[ApiVersion("2.0")]
//这里apiversion为关键字约束,xx:apiversion，xx为参数名，可以自定义,apiversion不能更改.会与[ApiVersion]作用
[Route("api/v{version:apiVersion}/[controller]}")]
public class CitiesController : ControllerBase
```

```C#
builder.Services.AddSwaggerGen(options =>
{
    options.IncludeXmlComments(Path.Combine(AppContext.BaseDirectory,"api.xml"));
    
    //注释掉也能跑,但是v2版本会报错
    options.SwaggerDoc("v1",new OpenApiInfo(){Title = "Cities Web API",Version = "1.0"});
    options.SwaggerDoc("v2",new OpenApiInfo(){Title = "Cities Web API",Version = "2.0"});
});

app.UseSwaggerUI(options =>
{
    //注释掉也没问题
    //options.SwaggerEndpoint("/swagger/v1/swagger.json", "1.0");
    //options.SwaggerEndpoint("/swagger/v2/swagger.json", "2.0");
});
```



----------------------------
<details>
<summary>老版本</summary>

# 老版本

- 基于控制器的API
- 创建最小 Web API

\[ApiController\] 指示控制器响应Web Api请求.

## 防止过度发布

DTO 数据传输对象

再声明一个对象，将表格发送的对象改为该对象，并且该对象的哪些属性可以更新源对象.

### 项目文件

文件:

Properties:

:   launchSettings.json,启动配置类,里面能看到端口

Controllers:

:   PizzaController.cs

    - `[ApiController]` 表明是一个ApiController控件,方便创建

    - `[Route("[controller]")]`
      路由设置,命名规范,在链接中直接删除Controller便是网址

    - 继承于ControllerBase类

    - 有一个默认的无参数构造器

    - 使用RESTful,GET,POST,PUT,DELETE,

      > `[HttpGet]` 无参数Get,返回类型 ActionResult\<List\<Pizza\>\>
      >
      > `[HttpGet("{id}")]` 有参数Get,返回类型
      > ActionResult\<List\<Pizza\>\>
      >
      > `[HttpPost]` 创建,返回类型
      > IActionResult\<List\<Pizza\>\>,返回类型不 固定,如
      > `CreatedAtAction`, `BadRequest`, `NotFound`, `NoContent`,
      > 所以使用接口
      >
      > `[HttpPut("{id}")]` 更新,返回类型 IActionResult\<List\<Pizza\>\>
      >
      > `[HttpDelete("{id}")]` 删除,返回类型
      > IActionResult\<List\<Pizza\>\>

Models:

:   Pizza.cs

    Pizza的类

Services:

:   PizzaService.cs,Pizza的服务类,处理类,

    里面有对Pizaas增删改查的方法.

ContosoPizza.csproj,项目文件,可以看到框架和依赖

ContosoPizza.http,用来测试REST的(没用过)

Program.cs,项目启动文件

### Swashbuckle NuGet包

Swashbuckle.AspNetCore.Swagger 一个 Swagger 对象模型和中间件， 用于将
SwaggerDocument 对象作为 JSON 终结点公开。

Swashbuckle.AspNetCore.SwaggerGen 一个 Swagger 生成器，
可直接从路由、控制器和模型构建 SwaggerDocument 对象。 它通常与 Swagger
终结点中间件结合使用，以自动显示 Swagger JSON。

Swashbuckle.AspNetCore.SwaggerUI Swagger UI 工具的嵌入式版本。 它解释了
Swagger JSON，以便为描述 Web API 功能构建丰富、可自定义的体验。
它包括针对公共方法的内置测试工具。

## Swagger中间件

    builder.Services.AddEndpointsApiExplorer();

    builder.Services.AddSwaggerGen(); 需要上面一行的调用.



    app.UseSwagger();

    if (app.Environment.IsDevelopment())
    {
        app.UseSwaggerUI();
    }

Swagger默认地址 `http:<hostname>:<port>/swagger`

------------------------------------------------------------------------

httprepl ,测试工具,在项目运行时使用
`httprepl https://localhost:{port}`或者
`httprepl https://localhost:{port}`,阅读-评估-打印-循环

</details>
