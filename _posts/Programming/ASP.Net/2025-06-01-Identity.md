---
categories: ASP.net
---

# Identity

![image](/Images/Identity.png)

Nuget包

`Microsoft.AspNetCore.Identit`

`Microsoft.AspNetCore.Identit.Entityframeworkcore`

## IdentityUser<T>

储存了基本信息,Id,UserName,PasswordHash,Email,PhoneNumber

T为Id的类型,默认为string

## IdentityRole<T>

用户角色,与权限有关.管理员或用户.

Id,Name

T为Id的类型,默认为string

## IdentityDbcontext<IdentityUser,IdentityRole,T>

不再继承Dbcontext,而是继承IdentityDbcontext.

## 添加服务

```C#
services.AddIdentity<ApplicationUser, ApplicationRole>()
    .AddEntityFrameworkStores<ApplicationDbContext>()
    //添加令牌服务,类似于验证码.
    .AddDefaultTokenProviders();

//如果ApplicationDbContext泛型明确提及了主键,那么就不需要下面这些
//AddUserStore<UserStore<ApplicationUser,ApplicationRole,ApplicationDbContext,Guid>>()
//AddRoleStore<RoleStore<ApplicationRole,ApplicationDbContext,Guid>>();*/
```

**设置好后,需要EFcore迁移更新创建表**

## UserManager

在Identity中不直接操作数据库，而是使用manager,类似于服务类.

```C#
private readonly UserManager<ApplicationUser>  _userManager;

//依赖注入
public AccountController(UserManager<ApplicationUser> userManager)
{
    _userManager = userManager;
}

//registerDTO来源于页面的模型绑定,不设置密码
var user = new ApplicationUser()
{
    Email = registerDTO.Email,
    PhoneNumber = registerDTO.Phone,
    UserName = registerDTO.Email,
    PersonName = registerDTO.PersonName,
};

//密码单独传入,因为数据库存的是哈希值.
IdentityResult result = await _userManager.CreateAsync(user,registerDTO.Password);
```

<details>
<summary>老版本</summary>

## 杨晓东 Savorboard

Claims 身份单元

ClaimsIdentity 身份证

ClaimsPrincipal 身份持有人

## 杨中科

用EFcore进行操作.

`Microsoft.AspNetCore.Identity.EntityFrameworkCore`

一个人(ClaimsPrincipal)有很多身份(ClaimsIdentity),一个身份有很多属性(Claim)

在web中, HttpContext.SignInAsync(\"MyCookieAuth\",ClaimsPrincipal);

必须在容器中注册 :

    //注册认证，并且使用项目中名为MyCookieAuth的Cookie,在网页中Cookie的Name也为MyCookieAuth.
    builder.Services.AddAuthentication().AddCookie("MyCookieAuth",options=>
    {
        options.Cookie.Name="MyCookieAuth"
    }
    )

TKey为主键类型

IdentityUser\<TKey\>

IdentityRole\<TKey\>

IdentityDbContext\<TUser,TRole,TKey\>

### 配置

`Services.AddDataProtection();` Web数据加密

`Services.AddIdentity();` 默认行为，有用户和角色服务

`Services.AddIdentityCore();` 只有用户服务，不需要角色管理

`Services.AddDefaultIdentity();` 有用户和角色额外再集成UI.

    //默认的密码强度非常高，建议修改。
    //返回IdentityBuidler
    services.AddIdentityCore<IdentityUser>(options=>
    {
        options.Password.RequireDigit = false;
        options.Password.RequireLowercase = false;
        options.Password.RequireUppercase = false;
        options.Password.RequiredLength = 1;
        //需要非数字字母字符
        options.Password.RequireNonAlphanumeric = false;
    });

`IdentityBuidler AddEntityFrameworkStores();`
将Identity框架与EFcore关联，使用EFcore操作Identity；

`IdentityBuidler AddUserManager(TManager);` 添加用户管理器

`IdentityBuidler AddRoleManager(TManager);` 添加角色管理器

### Manager

[userManager.CreateAsync]{#usermanager.createasync}(IdentityUser,password)

> 需要new IdentityUser()传入参数.不是单纯的传入账号和密码字符串
>
> 第二个参数直接传入string就可以，框架会自动变成passwordhash
>
> 别忘了Dbcontext.SaveChangesAsync();

</details>